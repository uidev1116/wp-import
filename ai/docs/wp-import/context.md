# a-blog cms WordPress移行プラグイン開発

## 目的
WordPressからa-blog cmsへの完全な移行を可能にするプラグインを開発する。
WordPress標準のエクスポート機能(Tools > Export)で出力されるWXRファイルを利用し、既存の標準移行機能では対応できないメディアファイルの移行を含む、包括的な移行ソリューションを提供する。

## 背景・現状の課題
- a-blog cms標準のWordPress移行機能は記事データ(エントリー)のみ対応
- WordPressのメディアライブラリをa-blog cmsのメディアデータに移行する機能が存在しない
- WordPress標準エクスポート(WXR形式)にはメディア情報は含まれるが、実ファイルは含まれない
- 手動でのメディア移行は大規模サイトでは非現実的

## 参考実装
microCMSのWordPress移行機能のアプローチを参考にする:
- WordPress標準エクスポート機能の活用
- メディアファイルのダウンロードと登録を自動化
- 移行先での包括的なデータ取り込み処理

参考URL:
- https://blog.microcms.io/wordpress-to-microcms-tutorial-preparation/
- https://blog.microcms.io/wordpress-to-microcms-tutorial-execution

既存実装:
@ablogcms/php/ACMS/POST/Import/Wordpress.php

## WordPress標準エクスポート(WXR)の仕様理解

### WXRファイルに含まれる情報
- 投稿、固定ページ、カスタム投稿タイプ
- カテゴリー、タグ、カスタムタクソノミー
- コメント
- カスタムフィールド(postmeta)
- **添付ファイル(attachment)の情報**
  - `<wp:post_type>attachment</wp:post_type>`
  - `<wp:attachment_url>` : メディアファイルのURL
  - 画像のメタ情報、ALTテキスト等

### WXRファイルに含まれない情報
- メディアファイルの実体(画像、PDF等のバイナリデータ)
- サムネイルの各サイズ画像(元画像のURLのみ)

## 技術要件

### a-blog cms側プラグイン(新規開発)

#### 1. WXRファイル解析機能
- XMLパーサーによるWXRファイルの読み込み
- WordPress Extended RSS (WXR) 1.2形式の対応
- 投稿データと添付ファイル(attachment)の分離抽出
- エラーハンドリング(不正なXML、破損ファイル等)

#### 2. エントリー移行処理
- 既存のa-blog cms標準WordPress移行機能との比較・統合検討
- WXRデータからエントリー情報の抽出
  - タイトル、本文(content)、抜粋(excerpt)
  - 投稿日時、更新日時、公開状態
  - 著者情報
- カテゴリー/タグのマッピング設定UI
  - WordPress → a-blog cms のカテゴリー対応表
  - 新規カテゴリーの自動生成 or 手動マッピング選択
- カスタムフィールドの移行(可能な範囲で)
  - a-blog cmsのカスタムフィールドへのマッピング
  - 対応できないフィールドのログ記録

#### 3. メディア移行処理(重点機能)
- WXRから添付ファイル情報の抽出
  - `<wp:attachment_url>` からメディアURLを取得
  - ファイル名、拡張子、アップロード日時
  - 画像メタデータ(width, height, ALTテキスト等)

- メディアファイルのダウンロード
  - WordPress側サーバーからHTTP/HTTPS経由でダウンロード
  - SSL証明書検証の設定
  - タイムアウト設定(大容量ファイル対応)
  - ダウンロード失敗時のリトライ機能

- a-blog cms メディアマネージャーへの登録
  - ファイルの適切なディレクトリへの保存
  - データベースへのメディア情報登録
  - サムネイル画像の生成(a-blog cms側の設定に準拠)
  - メディアとエントリーの関連付け

- 本文内パスの書き換え
  - エントリー本文中のWordPressメディアURLを検出
  - a-blog cms上の新しいメディアURLに置換
  - `<img>` タグ、`<a>` タグ内のURL書き換え
  - ショートコード内の画像参照の処理

#### 4. 進捗管理・ログ機能
- 管理画面での移行プロセス表示
  - 進捗バー(全体の何%完了か)
  - 現在処理中のアイテム表示

- バッチ処理による大量データ対応
  - 一定件数ごとに処理を分割
  - 処理状態の保存(中断・再開可能に)
  - PHPタイムアウト対策

- ログ記録機能
  - 成功/失敗したエントリー・メディアの記録
  - エラー詳細(ダウンロード失敗URL、原因等)
  - 移行完了後のサマリーレポート
  - ログファイルのエクスポート機能

#### 5. 管理画面UI
- WXRファイルアップロード画面
- 移行設定画面
  - カテゴリーマッピング設定
  - メディアダウンロード元URL設定(異なるドメインの場合)
  - バッチ処理サイズ設定
- 移行実行・進捗確認画面
- 移行結果レポート画面

## 技術的制約・考慮事項

### ディレクトリ構造

 @plugins/WPImport/src  に実装してください。

### a-blog cms 関連
- PHP 8.1以上(a-blog cms v3系の要件)
- a-blog cms のフック機構・プラグインアーキテクチャの活用
- 標準のメディア管理APIの利用
  - メディアファイルの保存先ディレクトリ構造
  - データベーステーブル構造(acms_*テーブル)
- 既存WordPress移行機能との共存・統合

参考ドキュメント:
- https://developer.a-blogcms.jp/document/
- https://developer.a-blogcms.jp/document/datamanagement/wp_import.html

### WordPress WXR形式
- XML構造の理解
  - `<item>` 要素(投稿・ページ・添付ファイル)
  - `<wp:postmeta>` 構造
  - 名前空間の取り扱い
- 文字エンコーディング(UTF-8)
- CDATAセクションの処理

### パフォーマンス
- XMLファイルサイズによるメモリ使用量
  - SAXパーサーの検討(大容量XML対応)
- 大量画像ダウンロード時のメモリ・時間管理
- タイムアウト対策
  - `set_time_limit()` の適切な設定
  - チャンク処理による分割実行
- 同時ダウンロード数の制限(サーバー負荷対策)

### セキュリティ
- 外部URLからのファイルダウンロード時の検証
  - ホワイトリスト方式のURL検証
  - ファイルタイプ・MIMEタイプチェック
  - ファイルサイズ制限
- XMLインジェクション対策
  - 外部実体参照(XXE)攻撃対策
  - libxml_disable_entity_loader() の活用
- アップロードディレクトリのパーミッション

### エラーハンドリング
- WordPress側サイトが既に削除されている場合の対応
  - メディアダウンロード失敗時の記録
  - スキップして続行 or 中断の選択
- ネットワークエラー(タイムアウト、DNS解決失敗等)
- ディスク容量不足
- ファイル名の重複処理

## 実装フェーズ

### Phase 1: WXR解析とエントリー移行(基本機能)
- XMLパーサーの実装・選定
- WXRファイルからエントリー情報の抽出
- 管理画面(ファイルアップロード)の実装
- 基本的なエントリー移行機能
- 既存標準移行機能との比較検証

### Phase 2: メディア情報の抽出と基本ダウンロード
- WXRから添付ファイル(attachment)情報の抽出
- メディアファイルの単純ダウンロード機能
- a-blog cms メディアディレクトリへの保存
- ダウンロード成功/失敗のログ記録

### Phase 3: メディアとエントリーの統合
- メディアとエントリーの関連付け
- 本文内画像URLの検出・書き換えロジック
- a-blog cms メディアマネージャーへの正式登録
- サムネイル生成処理

### Phase 4: 最適化・エラーハンドリング
- バッチ処理の実装(チャンク分割)
- 進捗表示UI
- エラー時のリトライ・スキップ機能
- 詳細ログ・レポート機能
- パフォーマンスチューニング

### Phase 5: カテゴリーマッピング等の追加機能
- カテゴリー/タグマッピングUI
- カスタムフィールド移行(可能な範囲で)
- 移行設定の保存・再利用機能

## 期待される成果物
1. a-blog cms用WordPress移行プラグイン
   - プラグインディレクトリ構造
   - 管理画面UI
   - WXR解析エンジン
   - メディアダウンロード・移行機能
2. 移行手順ドキュメント(README.md)
   - WordPress側でのエクスポート手順
   - a-blog cms側でのインポート手順
   - トラブルシューティング
3. テストケース・検証環境構築手順
4. ユーザーマニュアル

## 開発環境
- ローカル開発環境: MAMP/XAMPP/Docker等
- WordPress最新版(WXRエクスポート用)
- a-blog cms v3.2系最新版
- Git によるバージョン管理
- テスト用サンプルWXRファイル

## テストシナリオ
1. 小規模サイト(投稿10件、画像20ファイル程度)
2. 中規模サイト(投稿100件、画像200ファイル程度)
3. 大規模サイト(投稿1000件以上、画像1000ファイル以上)
4. メディアURL到達不可の場合の動作確認
5. 不正なWXRファイルのハンドリング

## 参考リソース
- a-blog cms開発者ドキュメント: https://developer.a-blogcms.jp/
- a-blog cms標準WordPress移行機能: https://developer.a-blogcms.jp/document/datamanagement/wp_import.html
- WordPress WXR仕様: https://wordpress.org/support/article/tools-export-screen/
- WordPress Codex - Importing Content: https://wordpress.org/documentation/article/importing-content/

---

このプロンプトを基に、段階的な実装計画を立案してください。
各フェーズでの具体的なファイル構成、クラス設計、主要関数の仕様、データフロー図の提案を含めてください。
特にメディア移行処理の詳細なロジック(URL抽出、ダウンロード、保存、紐付け、本文書き換え)に焦点を当てた設計を期待します。
